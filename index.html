<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ben Scalper - Deriv Trading Bot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #10b981;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-content {
            padding: 20px;
        }

        .login-card {
            background: #f7fafc;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .login-card h2 {
            margin-bottom: 15px;
            color: #2d3748;
            font-size: 20px;
        }

        .login-form {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .input-group {
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-size: 14px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .account-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .account-column {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
        }

        .info-item {
            margin-bottom: 15px;
        }

        .info-item:last-child {
            margin-bottom: 0;
        }

        .info-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 20px;
            font-weight: bold;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h3 {
            margin-bottom: 15px;
            color: #2d3748;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .control-buttons .btn {
            flex: 1;
            min-width: 150px;
            justify-content: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        .stat-card.profit {
            border-left-color: #10b981;
        }

        .stat-card.loss {
            border-left-color: #ef4444;
        }

        .trade-signal-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 3px solid #667eea;
        }

        .trade-signal-card h3 {
            margin-bottom: 15px;
            color: #2d3748;
            font-size: 18px;
        }

        .signal-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .signal-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .signal-label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .signal-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .signal-status {
            margin-top: 15px;
            padding: 15px;
            background: #f0fdf4;
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }

        .signal-status.no-signal {
            background: #fef3c7;
            border-left-color: #f59e0b;
        }

        .signal-status.buy-signal {
            background: #dcfce7;
            border-left-color: #10b981;
        }

        .signal-status.sell-signal {
            background: #fee2e2;
            border-left-color: #ef4444;
        }

        .indicator-status {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .indicator-status h4 {
            margin-bottom: 10px;
            color: #2d3748;
        }

        .indicator-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: #f7fafc;
            margin-bottom: 5px;
            border-radius: 5px;
            font-size: 14px;
        }

        .indicator-value {
            font-weight: bold;
            color: #667eea;
        }

        .trade-history {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .trade-history h3 {
            margin-bottom: 15px;
            color: #2d3748;
        }

        .history-table {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        table th {
            background: #2d3748;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        table tr:hover {
            background: #f7fafc;
        }

        .result-win {
            color: #10b981;
            font-weight: bold;
        }

        .result-loss {
            color: #ef4444;
            font-weight: bold;
        }

        .log-panel {
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #667eea;
            padding-left: 10px;
        }

        .log-entry.error {
            border-left-color: #ef4444;
            color: #fca5a5;
        }

        .log-entry.success {
            border-left-color: #10b981;
            color: #6ee7b7;
        }

        .log-entry.info {
            border-left-color: #3b82f6;
            color: #93c5fd;
        }

        .scroll-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .scroll-container::-webkit-scrollbar,
        .log-panel::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track,
        .log-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .scroll-container::-webkit-scrollbar-thumb,
        .log-panel::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .live-price {
            font-size: 16px;
            color: #10b981;
            font-weight: bold;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 18px;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }

            .account-info {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .control-buttons {
                flex-direction: column;
            }

            .control-buttons .btn {
                width: 100%;
            }

            .login-form {
                grid-template-columns: 1fr;
            }

            .container {
                border-radius: 0;
            }

            table {
                font-size: 12px;
            }

            table th,
            table td {
                padding: 8px 4px;
            }

            .signal-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 0;
            }

            .header {
                padding: 15px;
            }

            .main-content {
                padding: 10px;
            }

            .card {
                padding: 15px;
            }

            .stat-value {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>üìä</span>
                Ben Scalper Bot
            </h1>
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Disconnected</span>
            </div>
        </div>

        <div class="main-content">
            <!-- Login Card -->
            <div class="login-card" id="loginCard">
                <h2>üîê Deriv API Connection</h2>
                <div class="login-form">
                    <div class="input-group">
                        <label>API Token</label>
                        <input type="password" id="apiToken" placeholder="Enter your Deriv API token">
                        <div class="checkbox-group">
                            <input type="checkbox" id="rememberToken">
                            <label for="rememberToken">Remember my token</label>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="loginBtn">
                        <span>üöÄ</span> Connect
                    </button>
                </div>
                <div style="margin-top: 15px; padding: 12px; background: #fef3c7; border-radius: 8px; font-size: 13px;">
                    <strong>‚ö†Ô∏è Note:</strong> Get your API token from 
                    <a href="https://app.deriv.com/account/api-token" target="_blank" style="color: #667eea;">Deriv API Token Page</a>
                </div>
            </div>

            <!-- Account Information (Two Columns) -->
            <div class="account-info" id="accountInfo" style="display: none;">
                <div class="account-column">
                    <div class="info-item">
                        <div class="info-label">Account Type</div>
                        <div class="info-value" id="accountType">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Currency</div>
                        <div class="info-value" id="accountCurrency">-</div>
                    </div>
                </div>
                <div class="account-column">
                    <div class="info-item">
                        <div class="info-label">Balance</div>
                        <div class="info-value" id="accountBalance">0.00</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Session Time</div>
                        <div class="info-value" id="sessionTimer">00:00:00</div>
                    </div>
                </div>
            </div>

            <!-- Trading Settings and Risk Management -->
            <div class="grid-2" id="tradingSettings" style="display: none;">
                <div class="card">
                    <h3>‚öôÔ∏è Trading Settings</h3>
                    
                    <div class="form-group">
                        <label>Market</label>
                        <select id="market">
                            <option value="R_10">Volatility 10 Index</option>
                            <option value="R_25">Volatility 25 Index</option>
                            <option value="R_50">Volatility 50 Index</option>
                            <option value="R_75">Volatility 75 Index</option>
                            <option value="R_100">Volatility 100 Index</option>
                            <option value="stpRNG">Step Index 100</option>
                            <option value="stpRNG2">Step Index 200</option>
                            <option value="stpRNG3">Step Index 300</option>
                            <option value="stpRNG4">Step Index 400</option>
                            <option value="stpRNG5">Step Index 500</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Stake Amount</label>
                        <input type="number" id="stakeAmount" value="1" min="0.35" step="0.01">
                    </div>

                    <div class="form-group">
                        <label>Duration Type</label>
                        <select id="durationType">
                            <option value="t">Ticks</option>
                            <option value="s">Seconds</option>
                            <option value="m">Minutes</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Duration Value</label>
                        <input type="number" id="durationValue" value="5" min="1">
                    </div>
                </div>

                <div class="card">
                    <h3>üéØ Risk Management</h3>
                    
                    <div class="form-group">
                        <label>Stop Loss</label>
                        <input type="number" id="stopLoss" value="10" min="0" step="0.01">
                    </div>

                    <div class="form-group">
                        <label>Take Profit</label>
                        <input type="number" id="takeProfit" value="20" min="0" step="0.01">
                    </div>

                    <div style="padding: 15px; background: #f0fdf4; border-radius: 8px; margin-top: 15px;">
                        <div style="font-size: 12px; color: #166534; margin-bottom: 5px;">üí° Ben Scalper Strategy Active</div>
                        <div style="font-size: 11px; color: #15803d;">
                            TSI (25,13,7) + AO + EMA (50,200) + ADX (14)
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trade Signal Card -->
            <div class="trade-signal-card" id="tradeSignalCard" style="display: none;">
                <h3>üéØ Trade Signal Monitor</h3>
                <div class="signal-content">
                    <div class="signal-item">
                        <div class="signal-label">Current Market</div>
                        <div class="signal-value" id="currentMarket">-</div>
                        <div class="live-price" id="currentPrice">0.00</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-label">Signal Status</div>
                        <div class="signal-value" id="signalStatus">Waiting</div>
                    </div>
                </div>
                <div class="signal-status no-signal" id="signalMessage">
                    ‚è≥ Collecting market data... Need 200 ticks for analysis
                </div>
            </div>

            <!-- Current Market Indicators -->
            <div class="indicator-status" id="indicatorStatus" style="display: none;">
                <h4>üìà Live Market Indicators</h4>
                <div class="indicator-item">
                    <span>TSI Value:</span>
                    <span class="indicator-value" id="tsiSignal">Waiting...</span>
                </div>
                <div class="indicator-item">
                    <span>AO Momentum:</span>
                    <span class="indicator-value" id="aoSignal">Waiting...</span>
                </div>
                <div class="indicator-item">
                    <span>ADX Strength:</span>
                    <span class="indicator-value" id="adxSignal">Waiting...</span>
                </div>
                <div class="indicator-item">
                    <span>EMA 50:</span>
                    <span class="indicator-value" id="ema50Value">Waiting...</span>
                </div>
                <div class="indicator-item">
                    <span>EMA 200:</span>
                    <span class="indicator-value" id="ema200Value">Waiting...</span>
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="control-buttons" id="controlButtons" style="display: none;">
                <button class="btn btn-success" id="buyBtn">
                    <span>üìà</span> Buy (Rise)
                </button>
                <button class="btn btn-danger" id="sellBtn">
                    <span>üìâ</span> Sell (Fall)
                </button>
                <button class="btn btn-primary" id="autoTradeBtn">
                    <span>ü§ñ</span> Start Auto Trade
                </button>
                <button class="btn btn-secondary" id="stopAutoTradeBtn" style="display: none;">
                    <span>‚è∏Ô∏è</span> Stop Auto Trade
                </button>
            </div>

            <!-- Statistics (Under Auto Trade Button) -->
            <div class="stats-grid" id="statsGrid" style="display: none;">
                <div class="stat-card">
                    <div class="stat-label">Total Trades</div>
                    <div class="stat-value" id="totalTrades">0</div>
                </div>
                <div class="stat-card profit">
                    <div class="stat-label">Wins</div>
                    <div class="stat-value" id="winCount">0</div>
                </div>
                <div class="stat-card loss">
                    <div class="stat-label">Losses</div>
                    <div class="stat-value" id="lossCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">P/L</div>
                    <div class="stat-value" id="profitLoss">0.00</div>
                </div>
            </div>

            <!-- Trade History -->
            <div class="trade-history" id="tradeHistory" style="display: none;">
                <h3>üìú Trade History</h3>
                <div class="scroll-container">
                    <div class="history-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>S/N</th>
                                    <th>Time</th>
                                    <th>Market</th>
                                    <th>Type</th>
                                    <th>Stake</th>
                                    <th>Result</th>
                                </tr>
                            </thead>
                            <tbody id="tradeHistoryBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #9ca3af;">No trades yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Log Panel -->
            <div class="card" id="logCard" style="display: none;">
                <h3>üìã Activity Log</h3>
                <div class="log-panel" id="logPanel">
                    <div class="log-entry info">System initialized. Ready to connect...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let ws = null;
        let accountData = null;
        let sessionStartTime = null;
        let sessionTimerInterval = null;
        let autoTradeInterval = null;
        let isAutoTrading = false;
        let tickHistory = [];
        let tradeHistory = [];
        let currentMarketSymbol = '';
        let currentPrice = 0;
        let priceUpdateInterval = null;
        let stats = {
            total: 0,
            wins: 0,
            losses: 0,
            profitLoss: 0
        };

        // Indicators data
        let indicators = {
            tsi: { long: 25, short: 13, signal: 7, value: 0 },
            ao: { value: 0, prevValue: 0 },
            ema50: 0,
            ema200: 0,
            adx: { period: 14, value: 0 }
        };

        // Load saved settings
        function loadSettings() {
            const savedToken = localStorage.getItem('derivApiToken');
            const rememberToken = localStorage.getItem('rememberToken') === 'true';
            
            if (savedToken && rememberToken) {
                document.getElementById('apiToken').value = savedToken;
                document.getElementById('rememberToken').checked = true;
            }

            const savedMarket = localStorage.getItem('market');
            const savedStake = localStorage.getItem('stakeAmount');
            const savedDurationType = localStorage.getItem('durationType');
            const savedDurationValue = localStorage.getItem('durationValue');
            const savedStopLoss = localStorage.getItem('stopLoss');
            const savedTakeProfit = localStorage.getItem('takeProfit');

            if (savedMarket) document.getElementById('market').value = savedMarket;
            if (savedStake) document.getElementById('stakeAmount').value = savedStake;
            if (savedDurationType) document.getElementById('durationType').value = savedDurationType;
            if (savedDurationValue) document.getElementById('durationValue').value = savedDurationValue;
            if (savedStopLoss) document.getElementById('stopLoss').value = savedStopLoss;
            if (savedTakeProfit) document.getElementById('takeProfit').value = savedTakeProfit;
        }

        // Save settings
        function saveSettings() {
            const token = document.getElementById('apiToken').value;
            const remember = document.getElementById('rememberToken').checked;

            if (remember) {
                localStorage.setItem('derivApiToken', token);
                localStorage.setItem('rememberToken', 'true');
            } else {
                localStorage.removeItem('derivApiToken');
                localStorage.setItem('rememberToken', 'false');
            }

            localStorage.setItem('market', document.getElementById('market').value);
            localStorage.setItem('stakeAmount', document.getElementById('stakeAmount').value);
            localStorage.setItem('durationType', document.getElementById('durationType').value);
            localStorage.setItem('durationValue', document.getElementById('durationValue').value);
            localStorage.setItem('stopLoss', document.getElementById('stopLoss').value);
            localStorage.setItem('takeProfit', document.getElementById('takeProfit').value);
        }

        // Add settings change listeners
        ['market', 'stakeAmount', 'durationType', 'durationValue', 'stopLoss', 'takeProfit'].forEach(id => {
            document.getElementById(id).addEventListener('change', saveSettings);
        });

        // Market change listener for live price updates
        document.getElementById('market').addEventListener('change', function() {
            const newMarket = this.value;
            if (ws && ws.readyState === WebSocket.OPEN) {
                subscribeToTicks(newMarket);
                updateTradeSignalDisplay();
            }
        });

        // Logging function
        function addLog(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'Connected';
                addLog('Successfully connected to Deriv API', 'success');
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Disconnected';
                addLog('Disconnected from Deriv API', 'error');
            }
        }

        // Update Trade Signal Display
        function updateTradeSignalDisplay() {
            const marketSelect = document.getElementById('market');
            const marketName = marketSelect.options[marketSelect.selectedIndex].text;
            document.getElementById('currentMarket').textContent = marketName;
            document.getElementById('currentPrice').textContent = currentPrice.toFixed(2);
        }

        // Connect to Deriv API
        function connectToDerivAPI(apiToken) {
            return new Promise((resolve, reject) => {
                const appId = 1089;
                ws = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${appId}`);

                ws.onopen = () => {
                    addLog('WebSocket connection opened', 'info');
                    ws.send(JSON.stringify({ authorize: apiToken }));
                };

                ws.onmessage = (msg) => {
                    const data = JSON.parse(msg.data);
                    
                    if (data.error) {
                        addLog(`Error: ${data.error.message}`, 'error');
                        reject(data.error);
                        return;
                    }

                    if (data.msg_type === 'authorize') {
                        accountData = data.authorize;
                        updateAccountInfo(data.authorize);
                        updateConnectionStatus(true);
                        startSessionTimer();
                        
                        // Show all sections after login
                        showMainInterface();
                        
                        // Subscribe to current market ticks
                        const market = document.getElementById('market').value;
                        subscribeToTicks(market);
                        
                        resolve(data.authorize);
                    }

                    if (data.msg_type === 'balance') {
                        updateBalance(data.balance);
                    }

                    if (data.msg_type === 'buy') {
                        handleBuyResponse(data);
                    }

                    if (data.msg_type === 'proposal_open_contract') {
                        handleContractUpdate(data);
                    }

                    if (data.msg_type === 'tick') {
                        handleTickData(data);
                    }
                };

                ws.onerror = (error) => {
                    addLog('WebSocket error occurred', 'error');
                    updateConnectionStatus(false);
                    reject(error);
                };

                ws.onclose = () => {
                    updateConnectionStatus(false);
                    setTimeout(() => {
                        if (accountData) {
                            addLog('Attempting to reconnect...', 'info');
                            const token = document.getElementById('apiToken').value;
                            if (token) {
                                connectToDerivAPI(token).catch(() => {});
                            }
                        }
                    }, 5000);
                };
            });
        }

        // Show main interface after login
        function showMainInterface() {
            document.getElementById('accountInfo').style.display = 'grid';
            document.getElementById('tradingSettings').style.display = 'grid';
            document.getElementById('tradeSignalCard').style.display = 'block';
            document.getElementById('indicatorStatus').style.display = 'block';
            document.getElementById('controlButtons').style.display = 'flex';
            document.getElementById('statsGrid').style.display = 'grid';
            document.getElementById('tradeHistory').style.display = 'block';
            document.getElementById('logCard').style.display = 'block';
            document.getElementById('loginCard').style.display = 'none';
        }

        // Update account information
        function updateAccountInfo(authData) {
            document.getElementById('accountType').textContent = authData.is_virtual ? 'Demo' : 'Real';
            document.getElementById('accountCurrency').textContent = authData.currency;
            document.getElementById('accountBalance').textContent = parseFloat(authData.balance).toFixed(2);
            
            addLog(`Account loaded: ${authData.currency} ${parseFloat(authData.balance).toFixed(2)}`, 'success');

            ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
        }

        // Update balance
        function updateBalance(balanceData) {
            document.getElementById('accountBalance').textContent = parseFloat(balanceData.balance).toFixed(2);
        }

        // Session timer
        function startSessionTimer() {
            sessionStartTime = Date.now();
            sessionTimerInterval = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        // Calculate TSI (True Strength Index)
        function calculateTSI(prices) {
            if (prices.length < indicators.tsi.long + indicators.tsi.signal) return 0;
            
            const changes = [];
            for (let i = 1; i < prices.length; i++) {
                changes.push(prices[i] - prices[i - 1]);
            }
            
            const ema1 = changes.slice(-indicators.tsi.long).reduce((a, b) => a + b, 0) / indicators.tsi.long;
            const ema2 = changes.slice(-indicators.tsi.short).reduce((a, b) => a + b, 0) / indicators.tsi.short;
            return (ema2 / ema1) * 100 || 0;
        }

        // Calculate AO (Awesome Oscillator)
        function calculateAO(prices) {
            if (prices.length < 34) return 0;
            
            const sma5 = prices.slice(-5).reduce((a, b) => a + b, 0) / 5;
            const sma34 = prices.slice(-34).reduce((a, b) => a + b, 0) / 34;
            
            return sma5 - sma34;
        }

        // Calculate EMA
        function calculateEMA(prices, period) {
            if (prices.length < period) return 0;
            
            const k = 2 / (period + 1);
            let ema = prices.slice(-period).reduce((a, b) => a + b, 0) / period;
            
            for (let i = prices.length - period + 1; i < prices.length; i++) {
                ema = (prices[i] - ema) * k + ema;
            }
            
            return ema;
        }

        // Calculate ADX
        function calculateADX(highs, lows, closes) {
            if (closes.length < indicators.adx.period + 1) return 0;
            
            let trSum = 0;
            let dmPlusSum = 0;
            let dmMinusSum = 0;
            
            for (let i = 1; i < closes.length; i++) {
                const tr = Math.max(highs[i] - lows[i], 
                                   Math.abs(highs[i] - closes[i - 1]), 
                                   Math.abs(lows[i] - closes[i - 1]));
                const dmPlus = highs[i] - highs[i - 1];
                const dmMinus = lows[i - 1] - lows[i];
                
                trSum += tr;
                if (dmPlus > dmMinus && dmPlus > 0) dmPlusSum += dmPlus;
                if (dmMinus > dmPlus && dmMinus > 0) dmMinusSum += dmMinus;
            }
            
            const diPlus = (dmPlusSum / trSum) * 100;
            const diMinus = (dmMinusSum / trSum) * 100;
            const dx = Math.abs(diPlus - diMinus) / (diPlus + diMinus) * 100;
            
            return dx || 0;
        }

        // Analyze market signals
        function analyzeMarketSignals() {
            if (tickHistory.length < 200) {
                const signalMessage = document.getElementById('signalMessage');
                signalMessage.className = 'signal-status no-signal';
                signalMessage.textContent = `‚è≥ Collecting market data... ${tickHistory.length}/200 ticks`;
                document.getElementById('signalStatus').textContent = 'Waiting';
                return null;
            }

            const prices = tickHistory.map(t => t.quote);
            const currentPrice = prices[prices.length - 1];
            
            // Calculate all indicators
            const tsiValue = calculateTSI(prices);
            const aoValue = calculateAO(prices);
            const ema50 = calculateEMA(prices, 50);
            const ema200 = calculateEMA(prices, 200);
            const adxValue = calculateADX(prices, prices, prices);
            
            // Update indicator values
            indicators.tsi.value = tsiValue;
            indicators.ao.prevValue = indicators.ao.value;
            indicators.ao.value = aoValue;
            indicators.ema50 = ema50;
            indicators.ema200 = ema200;
            indicators.adx.value = adxValue;
            
            // Update UI with live indicator values
            document.getElementById('tsiSignal').textContent = tsiValue.toFixed(2);
            document.getElementById('aoSignal').textContent = aoValue > 0 ? `Bullish (${aoValue.toFixed(4)})` : `Bearish (${aoValue.toFixed(4)})`;
            document.getElementById('adxSignal').textContent = adxValue.toFixed(2);
            document.getElementById('ema50Value').textContent = ema50.toFixed(5);
            document.getElementById('ema200Value').textContent = ema200.toFixed(5);
            
            // Check for bullish divergence (BUY signal)
            const priceLowerLow = prices[prices.length - 1] < prices[prices.length - 50];
            const tsiHigherLow = tsiValue > -20 && tsiValue < indicators.tsi.value;
            const aoGreen = aoValue > indicators.ao.prevValue;
            const adxFalling = adxValue < 25;
            const priceNearEma50 = Math.abs(currentPrice - ema50) / currentPrice < 0.02;
            
            if (priceLowerLow && tsiHigherLow && aoGreen && adxFalling && priceNearEma50) {
                const signalMessage = document.getElementById('signalMessage');
                signalMessage.className = 'signal-status buy-signal';
                signalMessage.innerHTML = `
                    <strong>üìà BUY SIGNAL DETECTED</strong><br>
                    <small>Bullish divergence confirmed - All indicators aligned for upward movement</small>
                `;
                document.getElementById('signalStatus').textContent = 'BUY';
                document.getElementById('signalStatus').style.color = '#10b981';
                addLog('BUY signal: Bullish divergence detected', 'success');
                return 'BUY';
            }
            
            // Check for bearish divergence (SELL signal)
            const priceHigherHigh = prices[prices.length - 1] > prices[prices.length - 50];
            const tsiLowerHigh = tsiValue > 20 && tsiValue < indicators.tsi.value;
            const aoRed = aoValue < indicators.ao.prevValue;
            const priceAboveEma50 = Math.abs(currentPrice - ema50) / currentPrice < 0.02;
            
            if (priceHigherHigh && tsiLowerHigh && aoRed && adxFalling && priceAboveEma50) {
                const signalMessage = document.getElementById('signalMessage');
                signalMessage.className = 'signal-status sell-signal';
                signalMessage.innerHTML = `
                    <strong>üìâ SELL SIGNAL DETECTED</strong><br>
                    <small>Bearish divergence confirmed - All indicators aligned for downward movement</small>
                `;
                document.getElementById('signalStatus').textContent = 'SELL';
                document.getElementById('signalStatus').style.color = '#ef4444';
                addLog('SELL signal: Bearish divergence detected', 'success');
                return 'SELL';
            }
            
            const signalMessage = document.getElementById('signalMessage');
            signalMessage.className = 'signal-status no-signal';
            signalMessage.innerHTML = `
                <strong>‚è≥ No Signal</strong><br>
                <small>Monitoring market conditions - Waiting for optimal entry point</small>
            `;
            document.getElementById('signalStatus').textContent = 'No Signal';
            document.getElementById('signalStatus').style.color = '#667eea';
            return null;
        }

        // Handle tick data
        function handleTickData(data) {
            if (data.tick) {
                tickHistory.push(data.tick);
                currentPrice = data.tick.quote;
                
                // Update live price display
                document.getElementById('currentPrice').textContent = currentPrice.toFixed(2);
                
                // Keep only last 300 ticks
                if (tickHistory.length > 300) {
                    tickHistory.shift();
                }
                
                // Analyze signals
                analyzeMarketSignals();
            }
        }

        // Subscribe to ticks
        function subscribeToTicks(symbol) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('Not connected to Deriv API', 'error');
                return;
            }

            // Clear previous tick history when switching markets
            tickHistory = [];
            currentMarketSymbol = symbol;

            ws.send(JSON.stringify({
                ticks: symbol,
                subscribe: 1
            }));
            
            updateTradeSignalDisplay();
            addLog(`Subscribed to ${symbol} live feed`, 'info');
        }

        // Place trade
        function placeTrade(tradeType) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('Not connected to Deriv API', 'error');
                return;
            }

            const market = document.getElementById('market').value;
            const stake = parseFloat(document.getElementById('stakeAmount').value);
            const durationType = document.getElementById('durationType').value;
            const durationValue = parseInt(document.getElementById('durationValue').value);

            if (stake < 0.35) {
                addLog('Minimum stake is 0.35', 'error');
                return;
            }

            const proposal = {
                proposal: 1,
                amount: stake,
                basis: 'stake',
                contract_type: tradeType === 'BUY' ? 'CALL' : 'PUT',
                currency: accountData.currency,
                duration: durationValue,
                duration_unit: durationType,
                symbol: market
            };

            addLog(`Placing ${tradeType} order for ${market}...`, 'info');

            ws.send(JSON.stringify(proposal));

            const proposalHandler = (msg) => {
                const data = JSON.parse(msg.data);
                
                if (data.msg_type === 'proposal') {
                    if (data.error) {
                        addLog(`Proposal error: ${data.error.message}`, 'error');
                        ws.removeEventListener('message', proposalHandler);
                        return;
                    }

                    ws.send(JSON.stringify({
                        buy: data.proposal.id,
                        price: stake
                    }));

                    ws.removeEventListener('message', proposalHandler);
                }
            };

            ws.addEventListener('message', proposalHandler);
        }

        // Handle buy response
        function handleBuyResponse(data) {
            if (data.buy) {
                addLog(`Trade opened: Contract ID ${data.buy.contract_id}`, 'success');
                
                ws.send(JSON.stringify({
                    proposal_open_contract: 1,
                    contract_id: data.buy.contract_id,
                    subscribe: 1
                }));
            }
        }

        // Handle contract update
        function handleContractUpdate(data) {
            const contract = data.proposal_open_contract;
            
            if (!contract) return;

            if (contract.status === 'sold' || contract.is_sold) {
                const profit = parseFloat(contract.profit);
                const isWin = profit > 0;
                
                stats.total++;
                stats.profitLoss += profit;
                
                if (isWin) {
                    stats.wins++;
                } else {
                    stats.losses++;
                }
                
                document.getElementById('totalTrades').textContent = stats.total;
                document.getElementById('winCount').textContent = stats.wins;
                document.getElementById('lossCount').textContent = stats.losses;
                document.getElementById('profitLoss').textContent = stats.profitLoss.toFixed(2);
                
                const plElement = document.getElementById('profitLoss');
                plElement.style.color = stats.profitLoss >= 0 ? '#10b981' : '#ef4444';
                
                addTradeToHistory({
                    time: new Date().toLocaleTimeString(),
                    market: document.getElementById('market').value,
                    type: contract.contract_type === 'CALL' ? 'RISE' : 'FALL',
                    stake: contract.buy_price,
                    result: profit,
                    isWin: isWin
                });
                
                addLog(`Trade closed: ${isWin ? 'WIN' : 'LOSS'} - P/L: ${profit.toFixed(2)}`, isWin ? 'success' : 'error');
                
                const stopLoss = parseFloat(document.getElementById('stopLoss').value);
                const takeProfit = parseFloat(document.getElementById('takeProfit').value);
                
                if (stopLoss > 0 && Math.abs(stats.profitLoss) >= stopLoss) {
                    addLog('Stop loss reached! Stopping auto trade.', 'error');
                    stopAutoTrade();
                }
                
                if (takeProfit > 0 && stats.profitLoss >= takeProfit) {
                    addLog('Take profit reached! Stopping auto trade.', 'success');
                    stopAutoTrade();
                }
            }
        }

        // Add trade to history
        function addTradeToHistory(trade) {
            tradeHistory.unshift(trade);
            
            if (tradeHistory.length > 50) {
                tradeHistory.pop();
            }
            
            updateTradeHistoryTable();
        }

        // Update trade history table
        function updateTradeHistoryTable() {
            const tbody = document.getElementById('tradeHistoryBody');
            tbody.innerHTML = '';
            
            if (tradeHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #9ca3af;">No trades yet</td></tr>';
                return;
            }
            
            tradeHistory.slice(0, 10).forEach((trade, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${trade.time}</td>
                    <td>${trade.market}</td>
                    <td>${trade.type}</td>
                    <td>${parseFloat(trade.stake).toFixed(2)}</td>
                    <td class="${trade.isWin ? 'result-win' : 'result-loss'}">
                        ${trade.isWin ? '+' : ''}${parseFloat(trade.result).toFixed(2)}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Start auto trade
        function startAutoTrade() {
            if (isAutoTrading) return;
            
            isAutoTrading = true;
            document.getElementById('autoTradeBtn').style.display = 'none';
            document.getElementById('stopAutoTradeBtn').style.display = 'inline-flex';
            
            const market = document.getElementById('market').value;
            subscribeToTicks(market);
            
            addLog('Auto trade started - Monitoring for signals...', 'success');
            
            autoTradeInterval = setInterval(() => {
                const signal = analyzeMarketSignals();
                
                if (signal === 'BUY' || signal === 'SELL') {
                    placeTrade(signal);
                    
                    clearInterval(autoTradeInterval);
                    setTimeout(() => {
                        if (isAutoTrading) {
                            autoTradeInterval = setInterval(() => {
                                const newSignal = analyzeMarketSignals();
                                if (newSignal === 'BUY' || newSignal === 'SELL') {
                                    placeTrade(newSignal);
                                }
                            }, 10000);
                        }
                    }, 30000);
                }
            }, 10000);
        }

        // Stop auto trade
        function stopAutoTrade() {
            isAutoTrading = false;
            if (autoTradeInterval) {
                clearInterval(autoTradeInterval);
                autoTradeInterval = null;
            }
            
            document.getElementById('autoTradeBtn').style.display = 'inline-flex';
            document.getElementById('stopAutoTradeBtn').style.display = 'none';
            
            addLog('Auto trade stopped', 'info');
        }

        // Login button handler
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const apiToken = document.getElementById('apiToken').value.trim();
            
            if (!apiToken) {
                addLog('Please enter your API token', 'error');
                return;
            }

            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Connecting...';

            try {
                await connectToDerivAPI(apiToken);
                saveSettings();
                addLog('Login successful! Ready to trade.', 'success');
            } catch (error) {
                addLog('Login failed. Please check your API token.', 'error');
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<span>üöÄ</span> Connect';
            }
        });

        // Manual trade buttons
        document.getElementById('buyBtn').addEventListener('click', () => {
            placeTrade('BUY');
        });

        document.getElementById('sellBtn').addEventListener('click', () => {
            placeTrade('SELL');
        });

        // Auto trade buttons
        document.getElementById('autoTradeBtn').addEventListener('click', startAutoTrade);
        document.getElementById('stopAutoTradeBtn').addEventListener('click', stopAutoTrade);

        // Initialize on page load
        window.addEventListener('load', () => {
            loadSettings();
            addLog('Ben Scalper Bot initialized', 'success');
            addLog('Strategy: TSI + AO + EMA + ADX divergence trading', 'info');
        });

        // Handle page refresh
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>