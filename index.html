<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ben AI</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #e2e8f0; min-height: 100vh; padding: 10px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); padding: 12px 15px; border-radius: 12px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 12px; }
        .header-row-top { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 20px; font-weight: bold; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-status-group { display: flex; align-items: center; gap: 8px; }
        .session-timer { font-size: 11px; color: #94a3b8; background: rgba(15, 23, 42, 0.5); padding: 4px 10px; border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.1); }
        .connection-status { display: flex; align-items: center; gap: 5px; font-size: 11px; padding: 4px 10px; background: rgba(15, 23, 42, 0.5); border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.2); }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #ef4444; }
        .status-dot.online { background: #10b981; box-shadow: 0 0 6px #10b981; }
        .header-row-bottom { width: 100%; }
        .login-inline { display: flex; gap: 8px; width: 100%; }
        .login-inline input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid rgba(148, 163, 184, 0.3); background: rgba(15, 23, 42, 0.5); color: #e2e8f0; }
        #accountArea { display: flex; gap: 10px; align-items: center; width: 100%; }
        .balance { flex: 1; background: rgba(59, 130, 246, 0.1); padding: 10px 15px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3); display: flex; align-items: center; justify-content: space-between; font-size: 14px; }
        .account-badge { font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
        .badge-demo { background: #f59e0b; color: #0f172a; }
        .badge-real { background: #10b981; color: #ffffff; }
        .currency-badge { font-size: 10px; font-weight: 600; color: #94a3b8; border: 1px solid rgba(148, 163, 184, 0.3); padding: 1px 4px; border-radius: 3px; margin-left: 5px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 14px; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .main-grid { display: grid; grid-template-columns: 1fr 400px; gap: 20px; margin-bottom: 20px; }
        .card { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); border-radius: 12px; padding: 20px; border: 1px solid rgba(148, 163, 184, 0.1); margin-bottom: 20px; }
        .card-header { font-size: 18px; font-weight: 600; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(148, 163, 184, 0.2); }
        .ai-scanner { background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%); border: 2px solid rgba(139, 92, 246, 0.3); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .scanner-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .scanner-title-group { display: flex; flex-direction: column; }
        .scanner-label { font-size: 13px; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .scanner-market-display { font-size: 22px; font-weight: bold; display: flex; align-items: baseline; gap: 8px; flex-wrap: wrap; }
        .status-indicator { display: flex; align-items: center; gap: 6px; background: rgba(16, 185, 129, 0.1); padding: 4px 8px; border-radius: 20px; border: 1px solid rgba(16, 185, 129, 0.2); }
        .pulse { width: 8px; height: 8px; border-radius: 50%; background: #10b981; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .signal-display { text-align: center; padding: 30px; background: rgba(15, 23, 42, 0.5); border-radius: 10px; margin: 20px 0; }
        .signal-text { font-size: 32px; font-weight: bold; margin-bottom: 10px; }
        .signal-buy { color: #10b981; }
        .signal-sell { color: #ef4444; }
        .signal-undecided { color: #f59e0b; }
        .timer-control { display: flex; gap: 10px; align-items: center; margin: 15px 0; padding: 15px; background: rgba(15, 23, 42, 0.3); border-radius: 8px; }
        .timer-control input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid rgba(148, 163, 184, 0.3); background: rgba(15, 23, 42, 0.5); color: #e2e8f0; max-width: 100px; }
        .trade-mode { display: flex; gap: 10px; margin-bottom: 15px; }
        .trade-mode button { flex: 1; padding: 12px; border: 2px solid rgba(148, 163, 184, 0.3); background: rgba(15, 23, 42, 0.3); color: #94a3b8; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .trade-mode button.active { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-color: #3b82f6; color: white; }
        .inputs-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 5px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 12px; color: #94a3b8; }
        .form-group select, .form-group input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(148, 163, 184, 0.3); background: rgba(15, 23, 42, 0.5); color: #e2e8f0; }
        .control-btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; margin-top: 5px; }
        .btn-control { width: 100%; background: rgba(15, 23, 42, 0.4); border: 1px solid rgba(148, 163, 184, 0.3); color: #94a3b8; font-size: 11px; letter-spacing: 0.5px; padding: 10px; border-radius: 8px; cursor: pointer; transition: all 0.3s; text-transform: uppercase; font-weight: 600; display: flex; align-items: center; justify-content: center; text-align: center; }
        .btn-control.reverse-active { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); }
        .btn-control.cycler-active { background: rgba(16, 185, 129, 0.2); border-color: #10b981; color: #10b981; box-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
        .trade-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
        
        /* --- FILTERS CONFIG GRID --- */
        .filter-section {
            background: rgba(15, 23, 42, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            margin-bottom: 15px;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* Adjusted for fewer items */
            gap: 10px;
            margin-bottom: 15px;
        }
        .filter-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .filter-item label { font-size: 9px; color: #94a3b8; font-weight: bold; text-transform: uppercase; text-align: center; white-space: nowrap; }
        
        .restart-row {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .restart-row label { font-size: 11px; color: #94a3b8; font-weight: 600; }
        .restart-row input { 
            background: rgba(15, 23, 42, 0.5); 
            border: 1px solid rgba(148, 163, 184, 0.3); 
            color: #e2e8f0; 
            padding: 10px; 
            border-radius: 8px; 
            width: 100%; 
            font-size: 13px; 
        }

        .cycler-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        .cycler-item { display: flex; justify-content: space-between; align-items: center; background: rgba(15, 23, 42, 0.4); padding: 8px 10px; border-radius: 6px; border: 1px solid rgba(148, 163, 184, 0.1); font-size: 11px; min-height: 36px; }
        .cycler-item span { white-space: nowrap; }
        
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 20px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #475569; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .cycler-grid .toggle-switch { width: 30px; height: 16px; }
        .cycler-grid .slider:before { height: 12px; width: 12px; }
        .cycler-grid input:checked + .slider:before { transform: translateX(14px); }

        .log-panel { margin-top: 20px; background: rgba(15, 23, 42, 0.6); border-radius: 8px; border: 1px solid rgba(148, 163, 184, 0.2); padding: 12px; }
        .log-header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .log-header { font-size: 12px; font-weight: bold; color: #94a3b8; text-transform: uppercase; }
        .btn-clear-logs { background: none; border: 1px solid rgba(239, 68, 68, 0.4); color: #f87171; font-size: 10px; padding: 2px 8px; border-radius: 4px; cursor: pointer; }
        .log-container { height: 140px; overflow-y: auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; font-size: 13px; line-height: 1.5; color: #cbd5e1; }
        .log-entry { margin-bottom: 6px; border-bottom: 1px solid rgba(148, 163, 184, 0.1); padding-bottom: 6px; }
        .log-time { color: #64748b; margin-right: 8px; font-size: 12px; }
        .log-info { color: #60a5fa; font-weight: 500; }
        .log-error { color: #f87171; font-weight: bold; }
        .log-success { color: #34d399; font-weight: 500; }
        .log-warning { color: #fbbf24; font-weight: 500; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .stat-item { background: rgba(15, 23, 42, 0.4); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(148, 163, 184, 0.1); }
        .stat-label { font-size: 10px; color: #94a3b8; text-transform: uppercase; }
        .stat-value { font-size: 16px; font-weight: bold; margin-top: 4px; }
        .history-card { margin-top: 20px; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        .history-table th { text-align: left; padding: 8px; color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1); }
        .history-table td { padding: 8px; border-bottom: 1px solid rgba(148, 163, 184, 0.05); }
        .result-won { color: #10b981; font-weight: bold; }
        .result-lost { color: #ef4444; font-weight: bold; }
        .result-pending { color: #f59e0b; }
        .hidden { display: none; }
        @media (max-width: 1024px) { .main-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            .trade-actions { grid-template-columns: 1fr 1fr; }
            .inputs-grid { grid-template-columns: 1fr 1fr; }
            .control-btn-group { grid-template-columns: 1fr 1fr; }
            .cycler-grid { grid-template-columns: 1fr 1fr; }
            .filter-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-row-top">
                <div class="logo">ðŸ¤– Ben AI</div>
                <div class="header-status-group">
                    <div id="sessionDisplay" class="session-timer hidden">00:00:00</div>
                    <div class="connection-status">
                        <div class="status-dot" id="wsStatusDot"></div>
                        <span id="wsStatusText">Offline</span>
                    </div>
                </div>
            </div>
            <div class="header-row-bottom">
                <div id="loginArea" class="login-inline">
                    <input type="text" id="apiToken" placeholder="Enter Deriv API Token" />
                    <button class="btn btn-primary" onclick="login()">Connect</button>
                </div>
                <div id="accountArea" class="hidden">
                    <div class="balance">
                        <div>
                            <span id="accountBadge" class="account-badge"></span>
                            <span id="currencyBadge" class="currency-badge">--</span>
                        </div>
                        <span style="font-weight: bold; font-size: 16px;" id="accountBalance">0.00</span>
                    </div>
                    <button class="btn btn-danger" onclick="logout()" style="padding: 10px 15px;">Logout</button>
                </div>
            </div>
        </header>

        <div class="main-grid">
            <div>
                <div class="ai-scanner">
                    <div class="scanner-header-row">
                        <div class="scanner-title-group">
                            <div class="scanner-label">AI Market Scanner</div>
                            <div class="scanner-market-display">
                                <span id="scannerMarket" style="color: #3b82f6;">R_50</span>
                                <span id="scannerPrice" style="color: #10b981; font-size: 18px;">(--)</span>
                            </div>
                        </div>
                        <div class="status-indicator">
                            <div class="pulse" id="scanPulse"></div>
                            <span id="scanStatus" style="font-size: 11px; font-weight: bold; color: #10b981;">Active</span>
                        </div>
                    </div>
                    <div class="timer-control">
                        <label style="color: #94a3b8;">Scan Interval:</label>
                        <input type="number" id="scanInterval" value="5" min="1" max="60" onchange="updateScanInterval(); saveAllSettings();" />
                        <span style="color: #94a3b8;">minutes</span>
                    </div>
                    <div class="signal-display">
                        <div class="signal-text signal-undecided" id="signalText">Connect to start scanning...</div>
                        <div style="font-size: 14px; color: #94a3b8;">
                            Next scan in: <span id="countdown">--:--</span>
                        </div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 10px;">
                            Last updated: <span id="lastUpdate">--</span>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #94a3b8; margin-top: 15px;">
                        <strong>Analysis Factors:</strong> Multi-Timeframe Analysis (1m/5m/15m), Trend Strength, Momentum, Volatility Detection, Support/Resistance
                    </div>
                </div>
            </div>

            <div>
                <div class="card">
                    <div class="card-header">Trading Panel</div>
                    <div class="trade-mode">
                        <button class="active" id="manualBtn" onclick="setTradeMode('manual'); saveAllSettings();">Manual Trade</button>
                        <button id="autoBtn" onclick="setTradeMode('auto'); saveAllSettings();">Auto Trade</button>
                    </div>
                    <div class="inputs-grid">
                        <div class="form-group">
                            <label>Market Type</label>
                            <select id="marketType" onchange="updateMarket(); saveAllSettings();">
                                <option value="R_10">Volatility 10 Index</option>
                                <option value="R_25">Volatility 25 Index</option>
                                <option value="R_50" selected>Volatility 50 Index</option>
                                <option value="R_75">Volatility 75 Index</option>
                                <option value="R_100">Volatility 100 Index</option>
                                <option value="stpRNG">Step Index</option>
                                <option value="stpRNG2">Step Index 200</option>
                                <option value="stpRNG3">Step Index 300</option>
                                <option value="stpRNG4">Step Index 400</option>
                                <option value="stpRNG5">Step Index 500</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Stake Amount ($)</label>
                            <input type="number" id="tradeAmount" value="10" min="1" step="1" onchange="logInput('Stake', this.value); saveAllSettings();" />
                        </div>
                        <div class="form-group">
                            <label>Duration Type</label>
                            <select id="durationType" onchange="logInput('Duration Type', this.value); saveAllSettings();">
                                <option value="t">Ticks</option>
                                <option value="s">Seconds</option>
                                <option value="m" selected>Minutes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Duration Value</label>
                            <input type="number" id="durationValue" value="5" min="1" onchange="logInput('Duration Value', this.value); saveAllSettings();" />
                        </div>
                        <div class="form-group">
                            <label>Stop Loss ($)</label>
                            <input type="number" id="stopLoss" value="5" min="0" step="0.1" onchange="logInput('Stop Loss', this.value); saveAllSettings();" />
                        </div>
                        <div class="form-group">
                            <label>Take Profit ($)</label>
                            <input type="number" id="takeProfit" value="10" min="0" step="0.1" onchange="logInput('Take Profit', this.value); saveAllSettings();" />
                        </div>
                    </div>
                    <div class="control-btn-group">
                        <button id="cyclerBtn" class="btn-control" onclick="toggleCyclerMode()">Market Cycler: OFF</button>
                        <button id="reverseBtn" class="btn-control" onclick="toggleReverseMode()">Reverse Mode: OFF</button>
                    </div>
                    <div class="trade-actions">
                        <button class="btn btn-success" onclick="placeTrade('CALL')">ðŸ“ˆ BUY / CALL</button>
                        <button class="btn btn-danger" onclick="placeTrade('PUT')">ðŸ“‰ SELL / PUT</button>
                    </div>
                    <div class="log-panel">
                        <div class="log-header-container">
                            <div class="log-header">System Logs</div>
                            <button class="btn-clear-logs" onclick="clearLogs()">Clear</button>
                        </div>
                        <div class="log-container" id="logContainer">
                            <div class="log-entry"><span class="log-time">[--:--:--]</span> System ready.</div>
                        </div>
                    </div>
                    <div id="autoTradeInfo" class="hidden" style="margin-top: 20px; padding: 15px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.3);">
                        <strong>ðŸ¤– Auto Trade Active</strong>
                        <p style="font-size: 12px; color: #94a3b8; margin-top: 5px;">Trades will execute automatically based on AI signals</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Market Cycler Configuration</div>
                    
                    <div class="filter-section">
                        <div class="log-header" style="margin-bottom: 10px;">Signal Filters</div>
                        <div class="filter-grid">
                            <div class="filter-item">
                                <label>Timeframe Check</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="filterTimeframe" checked onchange="logInput('Timeframe Filter', this.checked); saveAllSettings()">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="filter-item">
                                <label>Consistency</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="filterConsistency" checked onchange="logInput('Consistency Filter', this.checked); saveAllSettings()">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="filter-item">
                                <label>Momentum</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="filterMomentum" checked onchange="logInput('Momentum Filter', this.checked); saveAllSettings()">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="filter-item">
                                <label>MA Conflict</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="filterMAConflict" checked onchange="logInput('MA Conflict Filter', this.checked); saveAllSettings()">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="filter-item">
                                <label>Trend Stable</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="filterTrendStability" checked onchange="logInput('Trend Stability', this.checked); saveAllSettings()">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="restart-row">
                        <label>Cycler Restart Timer (Hours)</label>
                        <input type="number" id="cyclerRestartHours" value="0" min="0" step="1" onchange="logInput('Cycler Timer', this.value); saveAllSettings()" />
                    </div>
                    
                    <div class="log-header" style="margin-top: 15px;">Active Markets</div>
                    <div class="cycler-grid">
                        <div class="cycler-item">
                            <span>Vol 10</span>
                            <label class="toggle-switch"><input type="checkbox" id="cycle_R_10" checked onchange="logInput('Cycler R_10', this.checked); saveAllSettings()"><span class="slider"></span></label>
                        </div>
                        <div class="cycler-item">
                            <span>Vol 25</span>
                            <label class="toggle-switch"><input type="checkbox" id="cycle_R_25" checked onchange="logInput('Cycler R_25', this.checked); saveAllSettings()"><span class="slider"></span></label>
                        </div>
                        <div class="cycler-item">
                            <span>Vol 50</span>
                            <label class="toggle-switch"><input type="checkbox" id="cycle_R_50" checked onchange="logInput('Cycler R_50', this.checked); saveAllSettings()"><span class="slider"></span></label>
                        </div>
                        <div class="cycler-item">
                            <span>Vol 75</span>
                            <label class="toggle-switch"><input type="checkbox" id="cycle_R_75" checked onchange="logInput('Cycler R_75', this.checked); saveAllSettings()"><span class="slider"></span></label>
                        </div>
                        <div class="cycler-item">
                            <span>Vol 100</span>
                            <label class="toggle-switch"><input type="checkbox" id="cycle_R_100" checked onchange="logInput('Cycler R_100', this.checked); saveAllSettings()"><span class="slider"></span></label>
                        </div>
                        <div class="cycler-item">
                            <span>Step Index</span>
                            <label class="toggle-switch"><input type="checkbox" id="cycle_stpRNG" checked onchange="logInput('Cycler Step', this.checked); saveAllSettings()"><span class="slider"></span></label>
                        </div>
                        <div class="cycler-item">
                            <span>Step 200</span>
                            <label class="toggle-switch"><input type="checkbox" id="cycle_stpRNG2" checked onchange="logInput('Cycler Step200', this.checked); saveAllSettings()"><span class="slider"></span></label>
                        </div>
                        <div class="cycler-item">
                            <span>Step 300</span>
                            <label class="toggle-switch"><input type="checkbox" id="cycle_stpRNG3" checked onchange="logInput('Cycler Step300', this.checked); saveAllSettings()"><span class="slider"></span></label>
                        </div>
                        <div class="cycler-item">
                            <span>Step 400</span>
                            <label class="toggle-switch"><input type="checkbox" id="cycle_stpRNG4" checked onchange="logInput('Cycler Step400', this.checked); saveAllSettings()"><span class="slider"></span></label>
                        </div>
                        <div class="cycler-item">
                            <span>Step 500</span>
                            <label class="toggle-switch"><input type="checkbox" id="cycle_stpRNG5" checked onchange="logInput('Cycler Step500', this.checked); saveAllSettings()"><span class="slider"></span></label>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">Trades</div>
                            <div class="stat-value" id="statTrades">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Win/Loss</div>
                            <div class="stat-value"><span id="statWins" style="color:#10b981">0</span>/<span id="statLoss" style="color:#ef4444">0</span></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">P/L</div>
                            <div class="stat-value" id="statPL">$0.00</div>
                        </div>
                    </div>
                    <div class="history-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 14px; font-weight: 600; color: #94a3b8;">Trade History</div>
                            <button onclick="clearTradeHistory()" style="background:none; border:none; color:#ef4444; font-size:10px; cursor:pointer;">Clear</button>
                        </div>
                        <table class="history-table">
                            <thead>
                                <tr><th>Time</th><th>Market</th><th>Type</th><th>Stake</th><th>Result</th></tr>
                            </thead>
                            <tbody id="historyBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let isLoggedIn = false;
        let currentMarket = 'R_50';
        let scanIntervalMinutes = 5;
        let scanTimer = null;
        let countdownTimer = null;
        let remainingSeconds = 0;
        let tradeMode = 'manual';
        let isReverseMode = false;
        let isCyclerActive = false; 
        let cyclerPL = 0; 
        let priceHistory = [];
        let isManuallyLoggedOut = false;
        
        let sessionStartTime = null;
        let sessionInterval = null;

        let totalTrades = 0;
        let totalWins = 0;
        let totalLoss = 0;
        let netPL = 0;
        let lastTradeAction = 'CALL'; 
        let savedTrades = [];
        
        // NEW: Scanner enhancement variables
        let lastScanData = null;
        let avgVol = 0;

        const cyclerMarketOrder = ['R_10', 'R_25', 'R_50', 'R_75', 'R_100', 'stpRNG', 'stpRNG2', 'stpRNG3', 'stpRNG4', 'stpRNG5'];

        window.onerror = function(msg, url, line, col, error) {
            addLog(`System Error: ${msg}`, 'error');
            return false;
        };

        function addLog(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString();
            let typeClass = 'log-info';
            if (type === 'error') typeClass = 'log-error';
            if (type === 'success') typeClass = 'log-success';
            if (type === 'warning') typeClass = 'log-warning';
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="${typeClass}">${message}</span>`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function logInput(name, value) {
            addLog(`Setting updated: ${name} = ${value}`, 'info');
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = "";
            addLog("System Logs cleared.", "warning");
        }

        function toggleReverseMode() {
            isReverseMode = !isReverseMode;
            const btn = document.getElementById('reverseBtn');
            if (isReverseMode) {
                btn.classList.add('reverse-active');
                btn.textContent = "Reverse Mode: ON";
                addLog("Reverse Mode Activated.", "warning");
            } else {
                btn.classList.remove('reverse-active');
                btn.textContent = "Reverse Mode: OFF";
                addLog("Reverse Mode Deactivated.", "info");
            }
            saveAllSettings();
        }

        function toggleCyclerMode() {
            isCyclerActive = !isCyclerActive;
            const btn = document.getElementById('cyclerBtn');
            if (isCyclerActive) {
                btn.classList.add('cycler-active');
                btn.textContent = "Market Cycler: ON";
                cyclerPL = 0; 
                addLog("Market Cycler Activated. Monitoring profit targets...", "success");
            } else {
                btn.classList.remove('cycler-active');
                btn.textContent = "Market Cycler: OFF";
                addLog("Market Cycler Deactivated.", "info");
            }
            saveAllSettings();
        }

        window.addEventListener('load', () => {
            loadAllSettings();
            loadTradeHistory();
            const storedToken = localStorage.getItem('deriv_api_token');
            if (storedToken) {
                document.getElementById('apiToken').value = storedToken;
                login(storedToken);
            }
        });

        function saveAllSettings() {
            const settings = {
                marketType: document.getElementById('marketType').value,
                tradeAmount: document.getElementById('tradeAmount').value,
                durationType: document.getElementById('durationType').value,
                durationValue: document.getElementById('durationValue').value,
                stopLoss: document.getElementById('stopLoss').value,
                takeProfit: document.getElementById('takeProfit').value,
                scanInterval: document.getElementById('scanInterval').value,
                cyclerRestartHours: document.getElementById('cyclerRestartHours').value,
                tradeMode: tradeMode,
                isReverseMode: isReverseMode,
                isCyclerActive: isCyclerActive,
                // SAVE ALL NEW LOGIC FILTERS
                filterTimeframe: document.getElementById('filterTimeframe').checked,
                filterConsistency: document.getElementById('filterConsistency').checked,
                filterMomentum: document.getElementById('filterMomentum').checked,
                filterMAConflict: document.getElementById('filterMAConflict').checked,
                filterTrendStability: document.getElementById('filterTrendStability').checked,
                toggles: {}
            };
            
            cyclerMarketOrder.forEach(m => {
                const el = document.getElementById(`cycle_${m}`);
                if (el) settings.toggles[m] = el.checked;
            });

            localStorage.setItem('trading_settings', JSON.stringify(settings));
        }

        function loadAllSettings() {
            const saved = localStorage.getItem('trading_settings');
            if (saved) {
                const s = JSON.parse(saved);
                document.getElementById('marketType').value = s.marketType || 'R_50';
                document.getElementById('tradeAmount').value = s.tradeAmount || 10;
                document.getElementById('durationType').value = s.durationType || 'm';
                document.getElementById('durationValue').value = s.durationValue || 5;
                document.getElementById('stopLoss').value = s.stopLoss || 5;
                document.getElementById('takeProfit').value = s.takeProfit || 10;
                document.getElementById('scanInterval').value = s.scanInterval || 5;
                document.getElementById('cyclerRestartHours').value = s.cyclerRestartHours || 0;
                
                // LOAD ALL LOGIC FILTERS
                if (s.filterTimeframe !== undefined) document.getElementById('filterTimeframe').checked = s.filterTimeframe;
                if (s.filterConsistency !== undefined) document.getElementById('filterConsistency').checked = s.filterConsistency;
                if (s.filterMomentum !== undefined) document.getElementById('filterMomentum').checked = s.filterMomentum;
                if (s.filterMAConflict !== undefined) document.getElementById('filterMAConflict').checked = s.filterMAConflict;
                if (s.filterTrendStability !== undefined) document.getElementById('filterTrendStability').checked = s.filterTrendStability;

                currentMarket = s.marketType || 'R_50';
                document.getElementById('scannerMarket').textContent = currentMarket;
                scanIntervalMinutes = parseInt(s.scanInterval) || 5;
                setTradeMode(s.tradeMode || 'manual');
                
                if (s.isReverseMode) {
                    isReverseMode = true;
                    document.getElementById('reverseBtn').classList.add('reverse-active');
                    document.getElementById('reverseBtn').textContent = "Reverse Mode: ON";
                }
                if (s.isCyclerActive) {
                    isCyclerActive = true;
                    document.getElementById('cyclerBtn').classList.add('cycler-active');
                    document.getElementById('cyclerBtn').textContent = "Market Cycler: ON";
                }

                if (s.toggles) {
                    cyclerMarketOrder.forEach(m => {
                        const el = document.getElementById(`cycle_${m}`);
                        if (el && s.toggles[m] !== undefined) el.checked = s.toggles[m];
                    });
                }
                
                addLog("Settings loaded.");
            }
        }

        function saveTradeToLocal(tradeObj) {
            savedTrades.unshift(tradeObj);
            if (savedTrades.length > 50) savedTrades.pop();
            localStorage.setItem('trade_history_log', JSON.stringify(savedTrades));
        }

        function loadTradeHistory() {
            const history = localStorage.getItem('trade_history_log');
            if (history) {
                savedTrades = JSON.parse(history);
                const table = document.getElementById('historyBody');
                table.innerHTML = "";
                totalTrades = 0; totalWins = 0; totalLoss = 0; netPL = 0;
                savedTrades.forEach(trade => {
                    const row = table.insertRow();
                    row.id = `trade-${trade.id}`;
                    row.innerHTML = `<td>${trade.time}</td><td>${trade.market}</td><td>${trade.type}</td><td>$${trade.stake}</td><td id="res-${trade.id}" class="${trade.resultClass}">${trade.result}</td>`;
                    totalTrades++;
                    if (trade.result === 'WON') { totalWins++; netPL += trade.profit; } 
                    else if (trade.result === 'LOST') { totalLoss++; netPL += trade.profit; }
                });
                updateStats();
            }
        }

        function clearTradeHistory() {
            if (confirm("Clear all trade history?")) {
                performHistoryClear();
            }
        }

        function performHistoryClear() {
            localStorage.removeItem('trade_history_log');
            savedTrades = [];
            totalTrades = 0;
            totalWins = 0;
            totalLoss = 0;
            netPL = 0;
            cyclerPL = 0; 
            document.getElementById('historyBody').innerHTML = "";
            updateStats();
            addLog("History cleared for next cycle.", "warning");
        }

        function updateStatusBadge(status) {
            const dot = document.getElementById('wsStatusDot');
            const text = document.getElementById('wsStatusText');
            if (status === 'online') { dot.classList.add('online'); text.textContent = 'Online'; } 
            else if (status === 'connecting') { dot.classList.remove('online'); text.textContent = 'Connecting...'; } 
            else { dot.classList.remove('online'); text.textContent = 'Offline'; }
        }

        function startSessionTimer() {
            if (sessionInterval) clearInterval(sessionInterval);
            sessionStartTime = Date.now();
            document.getElementById('sessionDisplay').classList.remove('hidden');
            sessionInterval = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const hrs = Math.floor(elapsed / 3600000).toString().padStart(2, '0');
                const mins = Math.floor((elapsed % 3600000) / 60000).toString().padStart(2, '0');
                const secs = Math.floor((elapsed % 60000) / 1000).toString().padStart(2, '0');
                document.getElementById('sessionDisplay').textContent = `Session: ${hrs}:${mins}:${secs}`;
            }, 1000);
        }

        function login(tokenParam = null) {
            const apiToken = tokenParam || document.getElementById('apiToken').value.trim();
            if (!apiToken) return;
            isManuallyLoggedOut = false;
            updateStatusBadge('connecting');
            ws = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=116948');
            ws.onopen = () => ws.send(JSON.stringify({ authorize: apiToken }));
            ws.onmessage = (msg) => {
                const data = JSON.parse(msg.data);
                if (data.error) { addLog(data.error.message, "error"); updateStatusBadge('offline'); return; }
                if (data.authorize) {
                    isLoggedIn = true;
                    localStorage.setItem('deriv_api_token', apiToken);
                    updateStatusBadge('online');
                    document.getElementById('loginArea').classList.add('hidden');
                    document.getElementById('accountArea').classList.remove('hidden');
                    document.getElementById('accountBalance').textContent = parseFloat(data.authorize.balance).toFixed(2);
                    document.getElementById('currencyBadge').textContent = data.authorize.currency;
                    const isDemo = data.authorize.is_virtual === 1;
                    document.getElementById('accountBadge').textContent = isDemo ? 'Demo' : 'Real';
                    document.getElementById('accountBadge').className = isDemo ? 'account-badge badge-demo' : 'account-badge badge-real';
                    ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
                    subscribeToMarket(currentMarket);
                    startScanner();
                    startSessionTimer();
                }
                if (data.tick && data.tick.symbol === currentMarket) updatePrice(data.tick.quote);
                if (data.msg_type === 'balance') document.getElementById('accountBalance').textContent = parseFloat(data.balance.balance).toFixed(2);
                if (data.msg_type === 'buy') {
                    totalTrades++;
                    updateStats();
                    addTradeToTable(data.buy.contract_id, data.buy.buy_price, lastTradeAction);
                    ws.send(JSON.stringify({ proposal_open_contract: 1, contract_id: data.buy.contract_id, subscribe: 1 }));
                }
                if (data.msg_type === 'proposal_open_contract' && data.proposal_open_contract.is_sold) handleFinishedTrade(data.proposal_open_contract);
            };
            ws.onclose = () => { updateStatusBadge('offline'); if (!isManuallyLoggedOut) setTimeout(() => login(apiToken), 5000); };
            ws.onerror = (e) => { addLog("WebSocket Error occurred.", "error"); };
        }

        function logout() {
            addLog("User logged out.");
            isManuallyLoggedOut = true;
            localStorage.removeItem('deriv_api_token');
            if (ws) ws.close();
            clearInterval(scanTimer);
            clearInterval(countdownTimer);
            location.reload();
        }

        function updatePrice(price) {
            document.getElementById('scannerPrice').textContent = price.toFixed(5);
            priceHistory.push(price);
            if (priceHistory.length > 200) priceHistory.shift();
        }

        function updateStats() {
            document.getElementById('statTrades').textContent = totalTrades;
            document.getElementById('statWins').textContent = totalWins;
            document.getElementById('statLoss').textContent = totalLoss;
            document.getElementById('statPL').textContent = (netPL >= 0 ? '$' : '-$') + Math.abs(netPL).toFixed(2);
            document.getElementById('statPL').style.color = netPL >= 0 ? '#10b981' : '#ef4444';
        }

        function addTradeToTable(id, stake, type) {
            const table = document.getElementById('historyBody');
            const row = table.insertRow(0);
            const timeStr = new Date().toLocaleTimeString();
            row.id = `trade-${id}`;
            row.innerHTML = `<td>${timeStr}</td><td>${currentMarket}</td><td>${type}</td><td>$${stake}</td><td id="res-${id}" class="result-pending">Pending</td>`;
            saveTradeToLocal({ id, time: timeStr, market: currentMarket, type, stake, result: 'Pending', resultClass: 'result-pending', profit: 0 });
        }

        function handleFinishedTrade(contract) {
            const id = contract.contract_id;
            const resCell = document.getElementById(`res-${id}`);
            if (!resCell || resCell.textContent !== 'Pending') return;
            const profit = parseFloat(contract.profit);
            netPL += profit;
            
            // NET PROFIT LOGIC
            cyclerPL += profit;

            if (profit > 0) { totalWins++; } else { totalLoss++; }
            
            const resultStatus = profit > 0 ? "WON" : "LOST";
            const resultClass = profit > 0 ? "result-won" : "result-lost";
            resCell.textContent = resultStatus;
            resCell.className = resultClass;
            addLog(`Trade ${resultStatus}: ${profit > 0 ? '+' : ''}${profit.toFixed(2)}`, profit > 0 ? 'success' : 'error');
            const tradeIdx = savedTrades.findIndex(t => t.id == id);
            if (tradeIdx !== -1) {
                savedTrades[tradeIdx].result = resultStatus;
                savedTrades[tradeIdx].resultClass = resultClass;
                savedTrades[tradeIdx].profit = profit;
                localStorage.setItem('trade_history_log', JSON.stringify(savedTrades));
            }
            updateStats();

            if (isCyclerActive) {
                checkCyclerStatus();
            }
        }

        function checkCyclerStatus() {
            const target = parseFloat(document.getElementById('takeProfit').value);
            // CHECK IF NET PROFIT REACHES TARGET
            if (cyclerPL >= target) {
                addLog(`Cycler Target Reached ($${cyclerPL.toFixed(2)}). Switching market...`, "success");
                moveToNextMarket();
            }
        }

        function moveToNextMarket() {
            const currentIdx = cyclerMarketOrder.indexOf(currentMarket);
            let nextIdx = currentIdx + 1;
            let foundNext = false;

            while (nextIdx < cyclerMarketOrder.length) {
                const m = cyclerMarketOrder[nextIdx];
                const isEnabled = document.getElementById(`cycle_${m}`).checked;
                if (isEnabled) {
                    performSwitch(m);
                    foundNext = true;
                    break;
                }
                nextIdx++;
            }

            if (!foundNext) {
                handleEndOfCycle();
            }
        }

        function performSwitch(newMarket) {
            document.getElementById('marketType').value = newMarket;
            performHistoryClear();
            updateMarket();
            addLog(`Cycler switched to ${newMarket}. Resuming auto-trade...`, "success");
            saveAllSettings();
        }

        function handleEndOfCycle() {
            const timer = parseFloat(document.getElementById('cyclerRestartHours').value);
            if (timer === 0) {
                addLog("Cycle finished. Stopping auto-trade.", "warning");
                setTradeMode('manual');
                saveAllSettings();
            } else {
                addLog(`Cycle finished. Waiting ${timer} hours to restart...`, "info");
                setTradeMode('manual');
                setTimeout(() => {
                    restartCycle();
                }, timer * 60 * 60 * 1000);
            }
        }

        function restartCycle() {
            addLog("Cycle timer elapsed. Restarting cycle...", "success");
            for (let i = 0; i < cyclerMarketOrder.length; i++) {
                const m = cyclerMarketOrder[i];
                if (document.getElementById(`cycle_${m}`).checked) {
                    performSwitch(m);
                    setTradeMode('auto');
                    break;
                }
            }
        }

        function subscribeToMarket(market) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addLog(`Subscribing to market: ${market}`);
                ws.send(JSON.stringify({ ticks: market, subscribe: 1 }));
            }
        }

        function updateMarket() {
            currentMarket = document.getElementById('marketType').value;
            addLog(`Market switched to ${currentMarket}`);
            document.getElementById('scannerMarket').textContent = currentMarket;
            priceHistory = [];
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ forget_all: "ticks" }));
                subscribeToMarket(currentMarket);
            }
        }

        function startScanner() {
            document.getElementById('scanStatus').textContent = 'Active';
            addLog("AI Market Scanner initialized.");
            generateSignal();
            scanTimer = setInterval(generateSignal, scanIntervalMinutes * 60 * 1000);
            startCountdown();
        }

        // --- HELPER FUNCTIONS ---
        // (Removed: RSI, ADX, AverageRange)

        // EMA Calculation (Required for Stage 5 MA Conflict)
        function calculateEMA(prices, period) {
            if (prices.length < period) return null;
            const k = 2 / (period + 1);
            // First EMA is SMA
            let ema = prices.slice(0, period).reduce((a, b) => a + b, 0) / period;
            for (let i = period; i < prices.length; i++) {
                ema = (prices[i] * k) + (ema * (1 - k));
            }
            return ema;
        }

        // ===== ENHANCED SCANNER FUNCTIONS =====
        
        // 1. Multi-Timeframe Analysis
        function analyzeTrend(prices) {
            if (prices.length < 10) return 'NONE';
            const recent = prices.slice(-Math.floor(prices.length / 2));
            const older = prices.slice(0, Math.floor(prices.length / 2));
            const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
            const olderAvg = older.reduce((a, b) => a + b, 0) / older.length;
            const diff = recentAvg - olderAvg;
            if (Math.abs(diff / olderAvg) < 0.0005) return 'NONE'; // Less than 0.05% change
            return diff > 0 ? 'BUY' : 'SELL';
        }

        // 3. Rate of Change Analysis
        function calculateRateOfChange(prices, lookback = 30) {
            if (prices.length < lookback) return 0;
            const current = prices[prices.length - 1];
            const past = prices[prices.length - lookback];
            const change = ((current - past) / past) * 100;
            const timeMinutes = lookback / 6; // ~6 ticks per minute
            return change / timeMinutes; // % change per minute
        }

        // 4. Directional Movement Consistency
        function calculateDirectionalConsistency(prices, period = 30) {
            if (prices.length < period) return { direction: 'NONE', consistency: 0 };
            const recent = prices.slice(-period);
            let upMoves = 0, downMoves = 0;
            
            for (let i = 1; i < recent.length; i++) {
                if (recent[i] > recent[i-1]) upMoves++;
                else if (recent[i] < recent[i-1]) downMoves++;
            }
            
            const total = upMoves + downMoves;
            if (total === 0) return { direction: 'NONE', consistency: 0 };
            const consistency = Math.max(upMoves, downMoves) / total * 100;
            const direction = upMoves > downMoves ? 'BUY' : 'SELL';
            
            return { direction, consistency };
        }

        // 5. Volatility Breakout Detection
        function detectVolatilityBreakout(prices) {
            if (prices.length < 100) return { breakout: false };
            
            const recentVol = calculateVolatility(prices.slice(-20), 20);
            const historicalVol = calculateVolatility(prices.slice(-100, -20), 80);
            
            if (historicalVol === 0) return { breakout: false };
            const volRatio = recentVol / historicalVol;
            
            if (volRatio > 1.5) {
                const direction = calculateDirectionalConsistency(prices.slice(-20));
                if (direction.consistency > 70) {
                    return { breakout: true, direction: direction.direction };
                }
            }
            
            return { breakout: false };
        }

        function calculateVolatility(prices, period) {
            if (prices.length < period) return 0;
            const slice = prices.slice(-period);
            const mean = slice.reduce((a, b) => a + b) / period;
            const variance = slice.reduce((sum, price) => 
                sum + Math.pow(price - mean, 2), 0) / period;
            return Math.sqrt(variance);
        }

        // 7. Moving Average Divergence Strength
        function calculateMADivergence(prices) {
            const ema5 = calculateEMA(prices, 5);
            const ema20 = calculateEMA(prices, 20);
            const ema50 = calculateEMA(prices, 50);
            
            if (!ema5 || !ema20 || !ema50) return null;
            
            const divergence = ((ema5 - ema50) / ema50) * 100;
            const strength = Math.abs(divergence);
            const direction = ema5 > ema20 && ema20 > ema50 ? 'BUY' : 
                             ema5 < ema20 && ema20 < ema50 ? 'SELL' : 'NONE';
            
            return { direction, strength, divergence };
        }

        function generateSignal() {
            if (priceHistory.length < 10) {
                document.getElementById('signalText').textContent = 'UNDECIDED';
                document.getElementById('signalText').className = 'signal-text signal-undecided';
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                remainingSeconds = scanIntervalMinutes * 60;
                return;
            }

            // Calculate average volatility for later use
            if (priceHistory.length >= 50) {
                avgVol = calculateVolatility(priceHistory, 50);
            }

            // ===== STAGE 1: DATA GATEKEEPER (ALWAYS ON) =====
            // This is mathematically required to run the other functions.
            if (priceHistory.length < 100) {
                addLog("Collecting data... Need 100+ ticks for accurate analysis", "info");
                setUndecidedSignal();
                return;
            }
            
            // ===== PRE-CALCULATE INDICATORS (Always needed) =====
            const shortTrend = analyzeTrend(priceHistory.slice(-6));    // ~1 min
            const mediumTrend = analyzeTrend(priceHistory.slice(-30));  // ~5 min
            const longTrend = analyzeTrend(priceHistory.slice(-90));    // ~15 min
            const consistency = calculateDirectionalConsistency(priceHistory, 40);
            const roc = calculateRateOfChange(priceHistory, 30);
            const maDiv = calculateMADivergence(priceHistory);
            
            // ===== STAGE 2: MULTI-TIMEFRAME CHECK (TOGGLEABLE) =====
            if (document.getElementById('filterTimeframe').checked) {
                if (!(shortTrend === mediumTrend && mediumTrend === longTrend)) {
                    addLog(`Timeframe Filter: Not aligned (1m=${shortTrend}, 5m=${mediumTrend})`, "info");
                    setUndecidedSignal();
                    return;
                }
                if (shortTrend === 'NONE') {
                    addLog("Timeframe Filter: No clear trend detected", "info");
                    setUndecidedSignal();
                    return;
                }
            } else {
                // If filter OFF, we still need a base direction, use Short Trend
                if (shortTrend === 'NONE') {
                     setUndecidedSignal();
                     return;
                }
            }
            
            // ===== STAGE 3: CONSISTENCY CHECK (TOGGLEABLE) =====
            if (document.getElementById('filterConsistency').checked) {
                if (consistency.consistency < 65) {
                    addLog(`Consistency Filter: ${consistency.consistency.toFixed(0)}% is too low (<65%)`, "warning");
                    setUndecidedSignal();
                    return;
                }
            }
            
            // ===== STAGE 4: MOMENTUM CHECK (TOGGLEABLE) =====
            if (document.getElementById('filterMomentum').checked) {
                if (Math.abs(roc) < 0.05) {
                    addLog(`Momentum Filter: ${roc.toFixed(3)}%/min is too slow`, "warning");
                    setUndecidedSignal();
                    return;
                }
            }
            
            // Volatility Breakout (Always logging, but not filtering unless added later)
            const breakout = detectVolatilityBreakout(priceHistory);
            if (breakout.breakout) {
                addLog(`ðŸ”¥ VOLATILITY BREAKOUT DETECTED: ${breakout.direction}`, "success");
            }
            
            // ===== STAGE 5: MA CONFLICT/CONFIRMATION (TOGGLEABLE) =====
            if (document.getElementById('filterMAConflict').checked) {
                if (maDiv && maDiv.direction !== 'NONE') {
                    if (maDiv.direction !== shortTrend) {
                        addLog(`MA Conflict Filter: MAs say ${maDiv.direction} but Trend is ${shortTrend}`, "warning");
                        setUndecidedSignal();
                        return;
                    }
                    if (maDiv.strength < 0.3) {
                        addLog(`MA Strength Filter: Divergence ${maDiv.strength.toFixed(2)}% too weak`, "warning");
                        setUndecidedSignal();
                        return;
                    }
                }
            }
            
            // ===== STAGE 6: TREND STABILITY / CONTINUITY (TOGGLEABLE) =====
            const currentPrice = priceHistory[priceHistory.length - 1];
            const currentSnapshot = {
                price: currentPrice,
                trend: shortTrend,
                momentum: roc,
                timestamp: Date.now()
            };
            
            if (document.getElementById('filterTrendStability').checked) {
                if (lastScanData) {
                    const trendContinuing = currentSnapshot.trend === lastScanData.trend;
                    if (!trendContinuing) {
                        addLog(`Stability Filter: Trend flipped since last scan. Unstable.`, "warning");
                        lastScanData = currentSnapshot;
                        setUndecidedSignal();
                        return;
                    }
                }
            }
            
            lastScanData = currentSnapshot;

            // (INDICATOR FILTERS REMOVED HERE)

            // ALL CONDITIONS MET - GENERATE SIGNAL
            const signal = shortTrend;
            
            if (signal === 'BUY') {
                document.getElementById('signalText').textContent = 'ðŸš€ BUY SIGNAL';
                document.getElementById('signalText').className = 'signal-text signal-buy';
                addLog(`âœ… BUY SIGNAL CONFIRMED`, "success");
                if (tradeMode === 'auto') placeTrade('CALL');
            } else if (signal === 'SELL') {
                document.getElementById('signalText').textContent = 'ðŸ“‰ SELL SIGNAL';
                document.getElementById('signalText').className = 'signal-text signal-sell';
                addLog(`âœ… SELL SIGNAL CONFIRMED`, "success");
                if (tradeMode === 'auto') placeTrade('PUT');
            }
            
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            remainingSeconds = scanIntervalMinutes * 60;
        }

        function setUndecidedSignal() {
            document.getElementById('signalText').textContent = 'UNDECIDED';
            document.getElementById('signalText').className = 'signal-text signal-undecided';
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            remainingSeconds = scanIntervalMinutes * 60;
        }

        function startCountdown() {
            if (countdownTimer) clearInterval(countdownTimer);
            countdownTimer = setInterval(() => {
                remainingSeconds--;
                const mins = Math.floor(remainingSeconds / 60);
                const secs = remainingSeconds % 60;
                document.getElementById('countdown').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function updateScanInterval() {
            const newInterval = parseInt(document.getElementById('scanInterval').value);
            scanIntervalMinutes = newInterval;
            addLog(`Scan interval updated to ${newInterval}m.`);
            // RESTART TIMER
            clearInterval(scanTimer);
            clearInterval(countdownTimer);
            startScanner();
        }

        function setTradeMode(mode) {
            tradeMode = mode;
            addLog(`Trade mode set to ${mode.toUpperCase()}`);
            document.getElementById('manualBtn').classList.toggle('active', mode === 'manual');
            document.getElementById('autoBtn').classList.toggle('active', mode === 'auto');
            document.getElementById('autoTradeInfo').classList.toggle('hidden', mode === 'manual');
        }

        function placeTrade(type) {
            if (!isLoggedIn) {
                addLog("Trade failed: Not connected.", "error");
                return;
            }
            let finalType = type;
            if (isReverseMode) {
                finalType = (type === 'CALL') ? 'PUT' : 'CALL';
                addLog(`Reverse active: Switching ${type} to ${finalType}`, "warning");
            }

            lastTradeAction = finalType;
            const amount = parseFloat(document.getElementById('tradeAmount').value);
            const duration = parseInt(document.getElementById('durationValue').value);
            const unit = document.getElementById('durationType').value;

            addLog(`Requesting ${type} order ($${amount})...`);
            ws.send(JSON.stringify({
                buy: "1",
                price: amount,
                parameters: {
                    amount, basis: "stake", contract_type: finalType,
                    currency: document.getElementById('currencyBadge').textContent,
                    duration, duration_unit: unit, symbol: currentMarket
                }
            }));
        }
    </script>
</body>
</html>
